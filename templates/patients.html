{% extends "layout.html" %}

{% block title %}Patients - Clinical Management System{% endblock %}

{% block content %}
<div class="slide-in">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-users mr-3 text-green-700"></i>Patient Management
        </h1>
        <button onclick="openAddPatientModal()" 
                class="bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg font-medium shadow-lg">
            <i class="fas fa-user-plus mr-2"></i>Add Patient
        </button>
    </div>

    <!-- Patients List -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">All Patients</h2>
                <div class="relative">
                    <input type="text" 
                           id="searchPatient" 
                           placeholder="Search patients..." 
                           onkeyup="searchPatients()"
                           class="w-64 px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
        </div>
        
        {% if patients %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Birth</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Blood Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody" class="bg-white divide-y divide-gray-200">
                    {% for patient in patients %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-user-circle text-gray-400 text-2xl mr-3"></i>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ patient.name }}</div>
                                    {% if patient.allergies %}
                                    <div class="text-xs text-red-600">
                                        <i class="fas fa-exclamation-triangle"></i> Allergies: {{ patient.allergies }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ patient.date_of_birth }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="calculate-age" data-dob="{{ patient.date_of_birth }}"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if patient.gender == 'Male' %}
                            <i class="fas fa-mars text-blue-600"></i>
                            {% else %}
                            <i class="fas fa-venus text-pink-600"></i>
                            {% endif %}
                            {{ patient.gender }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                {{ patient.blood_type or 'N/A' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if patient.contact %}
                            <i class="fas fa-phone mr-1"></i>{{ patient.contact }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="{{ url_for('add_to_consultation', patient_id=patient.id) }}" 
                               class="text-green-600 hover:text-green-900 mr-3"
                               title="Send to Consultation"
                               aria-label="Send patient {{ patient.name }} to consultation">
                                <i class="fas fa-user-md"></i>
                            </a>
                            <button onclick='openEditPatientModal({{ patient.id }}, `{{ patient.name }}`, `{{ patient.date_of_birth }}`, `{{ patient.gender }}`, `{{ patient.blood_type }}`, `{{ patient.allergies }}`, `{{ patient.contact }}`, `{{ patient.address }}`)' 
                                    class="text-blue-600 hover:text-blue-900 mr-3"
                                    title="Edit Patient"
                                    aria-label="Edit patient {{ patient.name }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="{{ url_for('delete_patient', id=patient.id) }}" 
                               onclick="return confirm('Are you sure you want to delete this patient? This will also delete all associated vitals and appointments.')" 
                               class="text-red-600 hover:text-red-900"
                               title="Delete Patient"
                               aria-label="Delete patient {{ patient.name }}">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <i class="fas fa-user-slash text-5xl mb-4"></i>
            <p class="text-lg">No patients registered yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-xl bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900">
                <i class="fas fa-user-plus mr-2 text-green-700"></i>Add New Patient
            </h3>
            <button onclick="closeAddPatientModal()" class="text-gray-400 hover:text-gray-600" title="Close" aria-label="Close modal">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('add_patient') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="add_name" class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="name" id="add_name" required placeholder="Enter full name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label for="add_date_of_birth" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
                    <input type="date" name="date_of_birth" id="add_date_of_birth" required max="{{ today }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="add_gender" class="block text-sm font-medium text-gray-700 mb-1">Gender *</label>
                    <select name="gender" id="add_gender" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="add_blood_type" class="block text-sm font-medium text-gray-700 mb-1">Blood Type</label>
                    <select name="blood_type" id="add_blood_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Blood Type</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div>
                    <label for="add_contact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                    <input type="text" name="contact" id="add_contact" placeholder="Phone number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="add_allergies" class="block text-sm font-medium text-gray-700 mb-1">Allergies</label>
                    <input type="text" name="allergies" id="add_allergies" placeholder="Any known allergies" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="add_address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea name="address" id="add_address" rows="2" placeholder="Complete address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeAddPatientModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Add Patient
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Patient Modal -->
<div id="editPatientModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-xl bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900">
                <i class="fas fa-user-edit mr-2 text-green-700"></i>Edit Patient
            </h3>
            <button onclick="closeEditPatientModal()" class="text-gray-400 hover:text-gray-600" title="Close" aria-label="Close modal">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <form method="POST" id="editPatientForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="edit_name" class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="name" id="edit_name" required placeholder="Enter full name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit_date_of_birth" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
                    <input type="date" name="date_of_birth" id="edit_date_of_birth" required max="{{ today }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit_gender" class="block text-sm font-medium text-gray-700 mb-1">Gender *</label>
                    <select name="gender" id="edit_gender" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="edit_blood_type" class="block text-sm font-medium text-gray-700 mb-1">Blood Type</label>
                    <select name="blood_type" id="edit_blood_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Blood Type</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div>
                    <label for="edit_contact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                    <input type="text" name="contact" id="edit_contact" placeholder="Phone number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit_allergies" class="block text-sm font-medium text-gray-700 mb-1">Allergies</label>
                    <input type="text" name="allergies" id="edit_allergies" placeholder="Any known allergies" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="edit_address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea name="address" id="edit_address" rows="2" placeholder="Complete address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeEditPatientModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i>Update Patient
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Calculate age from date of birth
    function calculateAge(dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }
    
    // Calculate and display ages on page load
    document.addEventListener('DOMContentLoaded', function() {
        const ageElements = document.querySelectorAll('.calculate-age');
        ageElements.forEach(element => {
            const dob = element.getAttribute('data-dob');
            if (dob) {
                element.textContent = calculateAge(dob) + ' yrs';
            }
        });
    });
    
    function searchPatients() {
        const input = document.getElementById('searchPatient');
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById('patientsTableBody');
        const rows = tbody.getElementsByTagName('tr');
        
        let visibleCount = 0;
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const name = row.cells[0].textContent.toLowerCase();
            const dob = row.cells[1].textContent.toLowerCase();
            const age = row.cells[2].textContent.toLowerCase();
            const gender = row.cells[3].textContent.toLowerCase();
            const bloodType = row.cells[4].textContent.toLowerCase();
            const contact = row.cells[5].textContent.toLowerCase();
            
            if (name.includes(filter) || dob.includes(filter) || age.includes(filter) || 
                gender.includes(filter) || bloodType.includes(filter) || 
                contact.includes(filter)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    function openAddPatientModal() {
        document.getElementById('addPatientModal').classList.remove('hidden');
    }
    
    function closeAddPatientModal() {
        document.getElementById('addPatientModal').classList.add('hidden');
    }
    
    function openEditPatientModal(id, name, date_of_birth, gender, blood_type, allergies, contact, address) {
        document.getElementById('editPatientForm').action = `/patients/edit/${id}`;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_date_of_birth').value = date_of_birth;
        document.getElementById('edit_gender').value = gender;
        document.getElementById('edit_blood_type').value = blood_type || '';
        document.getElementById('edit_allergies').value = allergies || '';
        document.getElementById('edit_contact').value = contact || '';
        document.getElementById('edit_address').value = address || '';
        document.getElementById('editPatientModal').classList.remove('hidden');
    }
    
    function closeEditPatientModal() {
        document.getElementById('editPatientModal').classList.add('hidden');
    }
</script>
{% endblock %}
